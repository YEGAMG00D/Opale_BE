name: Deploy Spring Boot to EC2 with Docker Compose

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1ï¸âƒ£ JAR ë¹Œë“œ
      - name: Build JAR
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test
          echo "ğŸ“¦ Build ê²°ê³¼:"
          ls -al build/libs

      # 2ï¸âƒ£ JAR ì—…ë¡œë“œ
      - name: Upload JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/home/ec2-user/opale_be"
          overwrite: true

      # 3ï¸âƒ£ EC2ì—ì„œ docker-compose up ì‹¤í–‰
      - name: Deploy on EC2 with Docker Compose
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /home/ec2-user/opale_be

            echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬:"
            pwd
            ls -al

            echo "ğŸ“‚ build/libs ë‚´ìš©:"
            ls -al build/libs || echo "âš  build/libs ì—†ìŒ"

            echo "ğŸ” ìµœì‹  JAR ì°¾ê¸° (plain ì œì™¸)"
            JAR_FILE=$(find build/libs -maxdepth 1 -name "*.jar" ! -name "*-plain.jar" | head -n 1)

            if [ -z "$JAR_FILE" ]; then
              echo "âŒ JAR íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. (build/libs í™•ì¸ í•„ìš”)"
              exit 1
            fi

            echo "ğŸ“¦ JAR íŒŒì¼ ë°œê²¬: $JAR_FILE â†’ app.jarë¡œ ë³µì‚¬"
            cp "$JAR_FILE" app.jar

            if [ ! -f /home/ec2-user/resources/application.yml ]; then
              echo "âŒ /home/ec2-user/resources/application.yml ì´ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi
            echo "âœ… application.yml ì¡´ì¬ í™•ì¸ë¨"

            echo "ğŸš€ docker-compose up -d --build ì‹¤í–‰"
            docker-compose up -d --build

            echo "ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker ps -a

            echo "ğŸ“œ opale-be ìµœê·¼ ë¡œê·¸:"
            docker logs opale-be --tail=200 || true
